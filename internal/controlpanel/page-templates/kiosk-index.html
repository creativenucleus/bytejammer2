<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>ByteJammer</title>

		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="">
		<meta name="author" content="jtruk/RiFT">

		<link href="/static/package/bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="/static/style/default.css" />
		<link rel="icon" type="image/x-icon" href="/static/media/favicon/favicon.ico">
	</head>
	<body>
		<div class="container">
			<div id="header">
				<h1>ByteWall!</h1>
			</div>

			<p>
				<button class="action-button" onclick="return SendSnapshotToServer()">Save TIC Effect</button>
				<button class="action-button" onclick="return ResetCode()">Reset</button>
			</p>
			
			<p>Websocket status: <span id="ws-local-status"></span></p>

			<textarea id="log" style="display: none"></textarea>

			<button onclick="toggleLog()">toggle log</button>
		</div>

		<dialog id="submitDialog">
			<form id="submitForm">
				<p>This will add your code to the Byte Wall! :)</p>
				<p>Please enter your name / scene name<p>
				<p>
					<label for="playerName">Your Name:</label>
					<input type="text" id="playerName" name="playerName" placeholder="l33tl4m3r" required maxlength="20">
				</p>

				<p>Please give your effect a name<p>
				<p>
					<label for="effectName">Effect Name:</label>
					<input type="text" id="effectName" name="effectName" placeholder="whizzy thing" required maxlength="20">
				</p>
				<div>
					<button id="cancelButton" type="reset">Cancel</button>
					<button id="submitButton">Confirm</button>
				</div>
			</form>
		</dialog>

		<div>
		<button id="updateDetails">Update details</button>
		</div>

		<script src="/static/package/bootstrap-5.3.8-dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/javascript/bytejammer.js"></script>
		<script>
			const ws = new BjmrWebSocket()
			const submitDialog = document.getElementById("submitDialog");
			const submitButton = document.getElementById("submitButton");
			const cancelButton = document.getElementById("cancelButton");
			const playerNameInput = document.getElementById("playerName");
			const effectNameInput = document.getElementById("effectName");

			const notSubmittedAlert = () => {
				alert("The effect was not submitted");
			}

			cancelButton.addEventListener("click", () => {
				submitDialog.close();
				notSubmittedAlert();
			});

			submitDialog.addEventListener("cancel", (event) => {
				notSubmittedAlert();
			});

			window.onload = () => {
				const conn = ws.open("ws://" + document.location.host + "/ws-kiosk");
                if(!conn) {
					addToLog('error', "Your browser does not support WebSockets");
					setWsLocalStatusText('error', "Your browser does not support WebSockets");
                    return;
                }

				addToLog('info', "Websocket to bytejammer.exe: Initialising...");

				conn.onerror = (error) => {
					addToLog("error", "Websocket to bytejammer.exe");
				}

				conn.onopen = () => {
					addToLog("success", "Websocket to bytejammer.exe: connected");
					setWsLocalStatusText('success', "Open")
				}
				
				conn.onclose = (event) => {
					if (event.wasClean) {
						addToLog("info", "Websocket to bytejammer.exe: Clean disconnect");
						setWsLocalStatusText('info', `Closed: Connection closed cleanly, code=${event.code} reason=${event.reason}`);
					} else {
						// e.g. server process killed or network down
						// event.code is usually 1006 in this case
						addToLog("error", "Websocket to bytejammer.exe: Unexpected disconnect");
						setWsLocalStatusText('error', 'Closed: Unexpected disconnect');
					}
				}

				conn.onmessage = (evt) => {
					const msg = JSON.parse(evt.data);
					switch(msg.type) {
						case "server-status":
							handleMsgServerStatus(msg.data);
							break;

						case "log":
							handleMsgLog(msg.log);
							break;

						default:
							console.error(`Unhandled message type ${msg.type}`);
					}
				}
			}

			const SendSnapshotToServer = () => {
				submitDialog.showModal();
			}

			submitButton.addEventListener("click", (event) => {
				event.preventDefault(); // Prevent form submission

				let playerName = playerNameInput.value.trim();
				let effectName = effectNameInput.value.trim();

				if (playerName == "") {
					alert("No submission made. Please enter your own name if you'd like to submit!")
					return false;
				}

				if (effectName == "") {
					alert("No submission made. Please enter your effect name if you'd like to submit!")
					return false;
				}

				ws.sendMsg("kiosk-make-snapshot", {
					"player_name": playerName,
					"effect_name": effectName
				});

				alert("Thank you for your submission!")

				submitForm.reset();
				submitDialog.close();

				return false;
			})

			const ResetCode = () => {
				if (window.confirm("This will erase your code. Did you take a snapshot of it?")) {
					ws.sendMsg("kiosk-new-player", {});
				}
				return false;
			}
		</script>
	</body>
</html>
