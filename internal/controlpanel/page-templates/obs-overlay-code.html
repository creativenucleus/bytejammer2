<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>ByteJammer: OBS Overlay</title>

        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="jtruk/RiFT">

        <link href="/static/package/bootstrap-5.3.3-dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/style/obs-overlay-bytejam.css" />
        <link rel="icon" type="image/x-icon" href="/static/media/favicon/favicon.ico">
        <script src="/static/javascript/bytejammer.js"></script>
    </head>
    <body id="obs-overlay" class="code">
        <div class="container">
            <div id="updateable"></div>
        </div>
		<div id="stage">(...hidden...)</div>

		<script>
			const ws = new BjmrWebSocket()
			const elUpdateable = document.getElementById("updateable");

            const setUpdateableContent = (content) => {
                elUpdateable.innerHTML = content;
            }

			let LastUpdateTime = Date.now();
			let CodeOpacity = 1.0;
			setInterval(() => {
				const timeFade = Date.now() - LastUpdateTime;
				CodeOpacity = Math.max(0, Math.min(2 - timeFade*.0004));
//				updateOverlayOpacity(document);
			}, 1000/30);

			const updateOverlayOpacity = (elAncestor) =>{
				const elOverlays = elAncestor.getElementsByClassName("inactive-fade");
				Array.from(elOverlays).forEach((elOverlay) => {
					console.log("1")
					elOverlay.style.opacity = CodeOpacity;
				});
			};

			window.onload = () => {
				const conn = ws.open("ws://" + document.location.host + "/ws-obs-overlay-code");
				if(!conn) {                    
					setWsLocalStatusText('error', "Your browser does not support WebSockets");
					// TODO: Bigger error?
				} else {
                    setUpdateableContent("<p>Websocket connection established. Waiting for updates...</p>");

					conn.onerror = (error) => {
					}

					conn.onopen = () => {
					}
					
					conn.onclose = (event) => {
					}

					conn.onmessage = (evt) => {
						const msg = JSON.parse(evt.data);
						switch(msg.type) {
							case "obs-overlay-html":
								// Staged update to prevent blinking
								const elTemplate = document.getElementById('stage');
    							elTemplate.innerHTML = msg.string_data;
								const elsToFade = elTemplate.getElementsByClassName("inactive-fade");
								Array.from(elsToFade).forEach((elToFade) => {
									elToFade.style.opacity = CodeOpacity;
								});
								elUpdateable.innerHTML = elTemplate.innerHTML;

								const elCursors = document.getElementsByClassName("cursor");
								if (elCursors.length > 0) {
									elCursors[0].scrollIntoView({block: "center"});
								}

								if (msg.data.isEditorUpdated) {
									LastUpdateTime = Date.now();
								}
								break;

							default:
								console.error(`Unhandled message type ${msg.type}`);
						}
					}
				}
			}
		</script>
    </body>
</html>
