<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>ByteJammer</title>

		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="">
		<meta name="author" content="jtruk/RiFT">

		<link href="/static/package/bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="/static/style/default.css" />
		<link rel="icon" type="image/x-icon" href="/static/media/favicon/favicon.ico">
	</head>
	<body>
		<nav class="navbar navbar-expand-md navbar-dark fixed-top" id="bj-navbar">
			<div class="container" role="container">
				<span>ByteJammer Studio</span>
				<span class="text-end">
					Connection to bytejammer.exe: <span id="ws-local-status"></span>
					<button class="d-none" id="action-reconnect">Reconnect</button>
				</span>
			</div>
		</nav>

		<main class="container" role="container">
			<div class="card mt-5 mb-5">
				<div class="card-header">
					<h2 class="card-title">Action - Launch TIC Runner</h2>
				</div>

				<div class="card-body">
					<form id="form-start-tic-runner" class="mb-2">
						<div class="row">
							<label for="listen-to-url" class="col-sm-2 col-form-label">Websocket URL</label>
							<div class="col-sm-10">
								<input type="url" class="form-control" id="listen-to-url" aria-describedby="help-listen-url">
								<div id="help-listen-url" class="form-text">i.e. ws://drone.alkama.com:9000/room/playername</div>
							</div>
						</div> 
						<div class="row mb-3">
							<label for="player-name" class="col-sm-2 col-form-label">Player Name</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="player-name" aria-describedby="help-player-name">
								<div id="help-player-name" class="form-text">e.g. jtruk (spaces and non-alphanumeric characters will be removed to make a URL)</div>
							</div>
						</div>
						<div class="row mb-3">
							<label for="obs-overlay" class="col-sm-2 col-form-label">OBS Overlay</label>
							<div class="col-sm-10">
								<select class="form-select" id="obs-overlay" aria-describedby="help-obs-overlay">
									<option selected value="">- choose -</option>
									<option value="none">None</option>
									<option value="code">Code</option>
								</select>
								<div id="help-obs-overlay" class="form-text">Selecting 'Code' launches an overlay</div>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-sm-10 offset-sm-2">
								<button class="btn btn-primary">Launch</button>
							</div>
						</div>
					</form>

					<hr>

					<table class="table table-sm table-striped table-hover align-middle mt-2">
						<thead>
							<tr>
								<th scope="col">Player</th>
								<th scope="col">Listen To URL<br>(source websocket)</th>
								<th scope="col">Overlay URL<br>(set for OBS browser location)</th>
								<th scope="col">File path for TIC<br>(use for --codeimport)</th>
								<th scope="col">#</th>
							</tr>
						</thead>
						<tbody class="table-group-divider" id="table-overlays-body">
						</tbody>
					</table>
				</div>
			</div>
		
			<div class="card mt-5 mb-5">
				<textarea id="log" style="display: none"></textarea>
				<button onclick="toggleLog()">toggle log</button>
			</div>

			<!-- Toast -->
			<div class="toast-container position-fixed bottom-0 end-0 p-3">
				<div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
					<div class="toast-header">
						<strong class="me-auto" id="toast-title"></strong>
						<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
					</div>
					<div class="toast-body" id="toast-body"></div>
				</div>
			</div>
		</div>

		<script src="/static/package/bootstrap-5.3.8-dist/js/bootstrap.bundle.min.js"></script>
		<script src="/static/javascript/bytejammer.js"></script>
		<script>
			const ws = new BjmrWebSocket()

			window.onload = () => {
				updateServerStatus(null);

				connectToServer();
			}

			const connectToServer = () => {
				const conn = ws.open("ws://" + document.location.host + "/ws/studio");
                if(!conn) {
					addToLog('error', "Your browser does not support WebSockets");
					setWsLocalStatusText('error', "Your browser does not support WebSockets");
                    return;
                }

				addToLog('info', "Websocket to bytejammer.exe: Initialising...");
				setWsLocalStatusText('info', "Initialising...");

				conn.onerror = (error) => {
					addToLog("error", "Websocket to bytejammer.exe");
				}

				conn.onopen = () => {
					addToLog("success", "Websocket connected to bytejammer.exe");
					setWsLocalStatusText('success', "Open")
				}
				
				conn.onclose = (event) => {
					if (event.wasClean) {
						addToLog("info", "Websocket to bytejammer.exe: Clean disconnect");
						setWsLocalStatusText('info', `Closed: Connection closed cleanly, code=${event.code} reason=${event.reason}`);
					} else {
						// e.g. server process killed or network down
						// event.code is usually 1006 in this case
						addToLog("error", "Websocket to bytejammer.exe: Unexpected disconnect");
						setWsLocalStatusText('error', 'Closed: Unexpected disconnect');
						elButtonReconnect.classList.remove("d-none");
					}
				}

				conn.onmessage = (evt) => {
					const msg = JSON.parse(evt.data);
					switch(msg.type) {
						case "studio-server-status":
							handleMsgServerStatus(msg.data);
							break;

						case "log":
							handleMsgLog(msg.data);
							break;

						default:
							console.error(`Unhandled message type ${msg.type}`);
					}
				}
			}

			// TODO: error handling
			const serverPost = (action, data) => {
				const url = 'http://' + document.location.host + "/action/" + action + '.json';

				return new Promise(async (resolve, reject) => {
					try {
						const res = await fetch(url, {
							method: 'POST',
							headers: {
								'Accept': 'application/json',
								'Content-Type': 'application/json'
							},
							body: JSON.stringify(data)
						});
						
						let result = null;
						try {
							result = await res.json();
						} catch (e) {
							// ignore (result = null)
						}

						if(!res.ok){
							reject(result);
							return;
						}
						
						resolve(result);
					} catch (error) {
						reject({message: error});
					}
				});
			}

			elButtonReconnect = document.getElementById("action-reconnect");
			elButtonReconnect.addEventListener("click", (event) => {
				elButtonReconnect.classList.add("d-none");
				connectToServer();
			});

			const form = document.getElementById("form-start-tic-runner");
			form.addEventListener("submit", (event) => {
				event.preventDefault();

				const listenToUrl = document.getElementById("listen-to-url").value
				const playerName = document.getElementById("player-name").value
				const obsOverlay = document.getElementById("obs-overlay").value
				if(!listenToUrl || !playerName || !obsOverlay){
					alert("Please fill in all fields");
					return false;
				}

				(async () => {
					const fnTitle = "Start TIC-80 Runner";
					serverPost('start-tic-runner', {
						listenToUrl: listenToUrl,
						playerName: playerName,
						obsOverlay: obsOverlay
					}).then((result) => {
						form.reset();
						showToast('success', fnTitle, result.message);
					}).catch((error) => {
						showToast('error', fnTitle, error.message);
					});
				})();
			});

			// Live event listener (for dynamically created elements)
			document.addEventListener("click", (event) => {
				const element = event.target;
				if(!element) {
					return;
				}

				const attrClickAction = element.getAttributeNode("data-action-click");
				if (!attrClickAction) {
					return;
				}

				event.preventDefault();
				switch(attrClickAction.value) {
					case "stop-tic-runner":
						const id = element.getAttributeNode("data-id").value;

						(async () => {
							const fnTitle = "Stop TIC-80 Runner";
							serverPost('stop-tic-runner', {
								id: id
							}).then((result) => {
								form.reset();
								showToast('success', fnTitle, result.message);
							}).catch((error) => {
								showToast('error', fnTitle, error.message);
							});
						})();
						break;
					case "copy-to-clipboard":
						const text = element.getAttributeNode("data-text").value;
						const valueName = element.getAttributeNode("data-value-name").value;
						navigator.clipboard.writeText(text).then(() => {
							showToast('success', 'Copy to Clipboard', `${valueName} copied to clipboard`);
						}).catch((err) => {
							showToast('error', 'Copy to Clipboard', 'Failed to copy ${valueName}: ' + err);
						});
						break;

					default:
						console.error(`Unhandled click action ${attrClickAction.value}`);
				}
			});

			const handleMsgServerStatus = (data) => {
				updateServerStatus(data);
			}

			const handleMsgLog = (data) => {
				addToLog(data.level, data.message);
			}

			const showToast = (severity, title, message) => {
				const elToast = document.getElementById('liveToast')
				const bsToast = bootstrap.Toast.getOrCreateInstance(elToast)

				elToast.classList.remove("bg-danger", "bg-success");
				switch(severity) {
					case 'success':
						elToast.classList.add("bg-success");
						break;
					case 'error':
						elToast.classList.add("bg-danger");
						break;
				}

				document.getElementById('toast-title').innerText = title;
				document.getElementById('toast-body').innerText = message;

				bsToast.show()
			}

			const updateServerStatus = (serverStatus) => {
				const elTableBody = document.getElementById('table-overlays-body')

				let innerHtml = "";
				if(!serverStatus || !serverStatus.overlays || !serverStatus.overlays.length) {
					innerHtml += `
						<tr>
							<td colspan="5" class="text-center">- (None Running) -</td>
						</tr>`;
				} else {
					serverStatus.overlays.forEach(overlay => {
						overlayButtonHTML = "";
						if(overlay.overlayURL) {
							overlayButtonHTML = `<button class="btn btn-primary" data-action-click="copy-to-clipboard" data-value-name="Overlay URL" data-text="${overlay.overlayURL}">Copy Overlay URL</button>`;
						}
						filepathButtonHTML = `<button class="btn btn-primary" data-action-click="copy-to-clipboard" data-value-name="File Path" data-text="${overlay.filePath}">Copy Filepath</button>`;
						
						innerHtml += 
							`<tr>` +
								`<td>${overlay.playerName}</td>` +
								`<td>${overlay.listenToURL}</td>` +
								`<td>${overlayButtonHTML}</td>` +
								`<td>${filepathButtonHTML}</td>` +
								`<td><button class="btn btn-danger" data-action-click="stop-tic-runner" data-id="${overlay.id}">Stop</button></td>` +
							`</tr>`;
					});
				}

				elTableBody.innerHTML = innerHtml;
			}
		</script>
	</body>
</html>
